blueprint:
  name: Ð Ð°ÑÑÐ²ÐµÑ‚
  description: Campanion Script to the parabolic alarm automation blueprint.
  domain: automation
  input:
    conditions:
      name: Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ
      description: Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      default: []
      selector:
        condition:

    alarm_start_time:
      name: ðŸ•’ Start Time
      description:
        Datetime helper or sensor for the alarm to start. Use time only and Workday sensor
        to determine what days to run.
      selector:
        entity:
          filter:
            - domain:
                - input_datetime
            - domain: sensor
              device_class: timestamp
          multiple: false

    offset_from_start_time:
      name: ðŸ Offset From Start Time
      description: Adjust the amount of time before or after the set Start Time value to start the transition. Enter seconds or HH:MM:SS format (e.g. "-00:05:00" to start 5 minutes before the Start Time. Useful if the start time comes from an alarm entity and you want to adjust where in the brightness cycle you are when the alarm goes off. See https://www.home-assistant.io/docs/automation/trigger/#sensors-of-datetime-device-class-with-offsets for caution about using positive offsets.
      default: "-00:00:00"
      selector:
        text:

    min_brightness_pct:
      description: ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ€ÐºÐ¾ÑÑ‚ÑŒ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð°Ñ… Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      selector:
        number:
          min: 1
          max: 30
          unit_of_measurement: "%"
      default: 1
      name: ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ€ÐºÐ¾ÑÑ‚ÑŒ

    max_brightness_pct:
      description: ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ€ÐºÐ¾ÑÑ‚ÑŒ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð°Ñ… Ð² ÐºÐ¾Ð½Ñ†Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      selector:
        number:
          min: 31
          max: 100
          unit_of_measurement: "%"
      default: 80
      name: ÐšÐ¾Ð½ÐµÑ‡Ð½Ð°Ñ ÑÑ€ÐºÐ¾ÑÑ‚ÑŒ

    duration:
      description: Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ð°Ñ…
      selector:
        number:
          min: 1
          max: 60
      default: 10
      name: Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹

    steps_per_minute:
      description: ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑˆÐ°Ð³Ð¾Ð² Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑÐ²ÐµÑ‚Ð° Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
      selector:
        number:
          min: 1
          max: 12
      default: 12
      name: Ð¨Ð°Ð³Ð¾Ð² Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ

    target_light:
      description: ÐžÐ´Ð¸Ð½ ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒÐ½Ð¸Ðº Ð¸Ð»Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð° ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒÐ½Ð¸ÐºÐ¾Ð²
      selector:
        entity:
          filter:
            domain: light
      name: Ð¦ÐµÐ»ÐµÐ²Ð¾Ð¹ ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒÐ½Ð¸Ðº

    light_timeout:
      description: ÐœÐ¸Ð½ÑƒÑ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ ÑÐ²ÐµÑ‚ Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸. Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ 0 Ð¾Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ ÑÐ²ÐµÑ‚ Ð½Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½
      selector:
        number:
          min: 0
          max: 60
      default: 5
      name: Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÑÐ²ÐµÑ‚Ð°

    start_g_color:
      description: ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð·ÐµÐ»ÐµÐ½Ð¾Ð³Ð¾ Ñ†Ð²ÐµÑ‚Ð° (0-255)
      selector:
        number:
          min: 0
          max: 255
      default: 0
      name: ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð·ÐµÐ»ÐµÐ½Ð¾Ð³Ð¾ Ñ†Ð²ÐµÑ‚Ð°

    end_g_color:
      description: ÐšÐ¾Ð½ÐµÑ‡Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð·ÐµÐ»ÐµÐ½Ð¾Ð³Ð¾ Ñ†Ð²ÐµÑ‚Ð° (0-255)
      selector:
        number:
          min: 0
          max: 255
      default: 190
      name: ÐšÐ¾Ð½ÐµÑ‡Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð·ÐµÐ»ÐµÐ½Ð¾Ð³Ð¾ Ñ†Ð²ÐµÑ‚Ð°

    start_b_color:
      description: ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÑÐ¸Ð½ÐµÐ³Ð¾ Ñ†Ð²ÐµÑ‚Ð° (0-255)
      selector:
        number:
          min: 0
          max: 255
      default: 0
      name: ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÑÐ¸Ð½ÐµÐ³Ð¾ Ñ†Ð²ÐµÑ‚Ð°

    end_b_color:
      description: ÐšÐ¾Ð½ÐµÑ‡Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÑÐ¸Ð½ÐµÐ³Ð¾ Ñ†Ð²ÐµÑ‚Ð° (0-255)
      selector:
        number:
          min: 0
          max: 255
      default: 100
      name: ÐšÐ¾Ð½ÐµÑ‡Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÑÐ¸Ð½ÐµÐ³Ð¾ Ñ†Ð²ÐµÑ‚Ð°


triggers:
  - trigger: time
    at:
      entity_id: !input alarm_start_time
      offset: !input offset_from_start_time

condition:
  condition: and
  conditions: !input conditions

variables:
  duration: !input duration
  steps_per_minute: !input steps_per_minute
  target_light: !input target_light
  light_timeout: !input light_timeout

  min_brightness: "{{ min_brightness_pct * 2.55 }}"
  max_brightness: "{{ max_brightness_pct * 2.55 }}"
  steps: "{{ duration * steps_per_minute }}"

  start_g_color: !input start_g_color
  end_g_color: !input end_g_color
  g_color_step: "{{ (end_g_color - start_g_color) / steps }}"

  start_b_color: !input start_b_color
  end_b_color: !input end_b_color
  b_color_step: "{{ (end_b_color - start_b_color) / steps }}"

  start_time: "{{ as_timestamp(now()) }}"
  individual_step: "{{ 60 / steps_per_minute }}"

actions:
  - data:
      brightness: "{{ min_brightness }}"
      rgb_color: "{{ [255, start_g_color, start_b_color] }}"
    target:
      entity_id: "{{ target_light }}"
    action: light.turn_on
  - repeat:
      until:
        - condition: or
          conditions:
            - condition: template
              value_template: "{{ is_state(target_light, 'off') }}"
            - condition: template
              value_template: "{{ state_attr(target_light, 'brightness') >= max_brightness }}"
            - condition: template
              value_template: >-
                {{ (((as_timestamp(now()) - start_time) / individual_step) |
                round(0, "ceil")) > steps }}
      sequence:
        - variables:
            steps_to_now: |-
              {{ ((as_timestamp(now()) - start_time) / individual_step) |
                round(0, "ceil") }}
            brightness: >-
              {{ min_brightness + (bright_step * steps_to_now) | round(0,
              'ceil') }}
            g_color: >-
              {{ start_g_color + (g_color_step * steps_to_now) | round(0,
              'ceil') }}
            b_color: >-
              {{ start_b_color + (b_color_step * steps_to_now) | round(0,
              'ceil') }}
        - delay:
            seconds: "{{ individual_step }}"
        - if:
            - condition: template
              value_template: "{{ not is_state(target_light, 'off') }}"
          then:
            - data:
                brightness: "{{ brightness }}"
                rgb_color: "{{ [255, g_color, b_color] }}"
                transition: "{{ individual_step / 2 }}"
              target:
                entity_id: "{{ target_light }}"
              action: light.turn_on
  - if:
      - condition: and
        conditions:
          - condition: template
            value_template: "{{ light_timeout != 0 }}"
          - condition: template
            value_template: "{{ not is_state(target_light, 'off') }}"
    then:
      - delay:
          minutes: "{{ light_timeout }}"
      - data: {}
        target:
          entity_id: "{{ target_light }}"
        action: light.turn_off

mode: single
