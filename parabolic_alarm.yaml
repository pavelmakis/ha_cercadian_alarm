blueprint:
  name: Ð Ð°ÑÑÐ²ÐµÑ‚
  description: Campanion Script to the parabolic alarm automation blueprint.
  domain: automation
  input:
    conditions:
      name: Ð£ÑÐ»Ð¾Ð²Ð¸Ñ
      description: ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      default: []
      selector:
        condition:

    alarm_start_time:
      name: ðŸ•’ Start Time
      description:
        Datetime helper or sensor for the alarm to start. Use time only and Workday sensor
        to determine what days to run.
      selector:
        entity:
          filter:
            - domain:
                - input_datetime
            - domain: sensor
              device_class: timestamp
          multiple: false

    offset_from_start_time:
      name: ðŸ Offset From Start Time
      description: Adjust the amount of time before or after the set Start Time value to start the transition. Enter seconds or HH:MM:SS format (e.g. "-00:05:00" to start 5 minutes before the Start Time. Useful if the start time comes from an alarm entity and you want to adjust where in the brightness cycle you are when the alarm goes off. See https://www.home-assistant.io/docs/automation/trigger/#sensors-of-datetime-device-class-with-offsets for caution about using positive offsets.
      default: "-00:00:00"
      selector:
        text:



    target_kelvin:
      description: Ð¢ÐµÐ¿Ð»Ð¾Ñ‚Ð° Ñ…Ð¾Ð»Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÑÐ²ÐµÑ‚Ð°. Ð­Ñ‚Ð¾ ÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ - Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ Ð±ÐµÐ»Ð¾Ðµ
      selector:
        color_temp:
          unit: kelvin
      default: 6500
      name: Coldest Kelvin

    start_kelvin:
      description: >-
        This is the start value. If the light is on the current value from the
        state of the light will be used and this will be ignored.
      selector:
        color_temp:
          unit: kelvin
          min: 2500
          max: 6500
      default: 2500
      name: Warmest Kelvin

    max_brightness_pct:
      description: ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ€ÐºÐ¾ÑÑ‚ÑŒ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð°Ñ… Ð² ÐºÐ¾Ð½Ñ†Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      selector:
        number:
          min: 1
          max: 100
      default: 80
      name: ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ€ÐºÐ¾ÑÑ‚ÑŒ

    duration:
      description: Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ð°Ñ…
      selector:
        number:
          min: 1
          max: 60
      default: 10
      name: Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹


    steps_per_minute:
      description: ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑˆÐ°Ð³Ð¾Ð² Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑÐ²ÐµÑ‚Ð° Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
      selector:
        number:
          min: 1
          max: 12
      default: 12
      name: Ð¨Ð°Ð³Ð¾Ð² Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ

    target_light:
      description: ÐžÐ´Ð¸Ð½ ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒÐ½Ð¸Ðº Ð¸Ð»Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð° ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒÐ½Ð¸ÐºÐ¾Ð²
      selector:
        entity:
          filter:
            domain: light
      name: Ð¦ÐµÐ»ÐµÐ²Ð¾Ð¹ ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒÐ½Ð¸Ðº

    light_timeout:
      description: ÐœÐ¸Ð½ÑƒÑ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ ÑÐ²ÐµÑ‚ Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸. Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ 0 Ð¾Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ ÑÐ²ÐµÑ‚ Ð½Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½
      selector:
        number:
          min: 0
          max: 60
      default: 5
      name: Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÑÐ²ÐµÑ‚Ð°

trigger:
  - trigger: time
    at:
      entity_id: !input alarm_start_time
      offset: !input offset_from_start_time

conditions:
  condition: and
  conditions: !input conditions


variables:
  steps: "{{ duration * steps_per_minute }}"
  min_brightness: "{{ 3 }}"
  max_brightness: "{{ max_brightness_pct * 2.55 }}"
  start_g_color: "{{ 172 }}"
  stop_g_color: "{{ 205 }}"
  g_color_step: "{{ (stop_g_color - start_g_color) / steps }}"
  kelvin_step: "{{ (target_kelvin - start_kelvin) / steps }}"
  bright_step: "{{ (max_brightness - min_brightness) / steps }}"
  start_time: "{{ as_timestamp(now()) }}"
  individual_step: "{{ 60 / steps_per_minute }}"






action:
  - action: light.turn_on
    data:
      brightness_pct: "{{ min_brightness }}"
      rgb_color:
        - 234
        - "{{ start_g_color  }}"
        - 43
      entity_id: !input target_light

  - repeat:
      until:
        - condition: or
          conditions:
            - condition: template
              value_template: "{{ is_state(target_light, 'off') }}"
            - condition: template
              value_template: "{{ state_attr(target_light, 'rgb_color')[1] >= stop_g_color }}"

      sequence:
        - variables:
            steps_to_now: |-
              {{ ((as_timestamp(now()) - start_time) / individual_step) |
                round(0, "ceil") }}
            brightness: >-
              {{ min_brightness + (bright_step * steps_to_now) | round(0,
              'ceil') }}
            kelvin: "{{ start_kelvin + (kelvin_step * steps_to_now) }}"
        - delay:
            seconds: "{{ individual_step }}"
        - if:
            - condition: template
              value_template: "{{ not is_state(target_light, 'off') }}"
          then:
            - data:
                brightness: "{{ brightness }}"
                rgb_color:
                  - 234
                  - "{{ start_g_color + (g_color_step * steps_to_now) }}"
                  - 43
              target:
                entity_id: !input target_light
              action: light.turn_on




mode: single